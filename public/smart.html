<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* カラーパレット定義 */
        :root {
            --bg-color: #f4ece2;
            --accent-pink: #d8a8a8;
            --text-brown: #6d4c41;
            --gold: #c5a572;
        }

        body {
            font-family: 'Noto Serif JP', serif;
            text-align: center;
            background: linear-gradient(135deg, #fffbf5 0%, #f4ece2 100%);
            color: var(--text-brown);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        /* 画面全体のクラシックな飾り枠 */
        body::before {
            content: "";
            position: absolute;
            top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 2px solid var(--gold);
            box-shadow: inset 0 0 0 4px var(--bg-color), inset 0 0 0 5px var(--text-brown);
            z-index: -1;
            pointer-events: none;
        }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--text-brown);
            letter-spacing: 2px;
        }
        p { font-size: 0.9em; color: var(--text-brown); }
        
        /* スタートボタン：楕円形で高級感のあるデザイン */
        #startBtn {
            width: 180px; height: 180px;
            font-size: 1.2em;
            font-family: 'Cinzel', serif;
            background: linear-gradient(to bottom, var(--accent-pink), #c08a8a);
            color: #fff;
            border: none;
            border-radius: 50%; /* 完全な円 */
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(216, 168, 168, 0.4);
            transition: all 0.3s;
            display: flex; justify-content: center; align-items: center; text-align: center;
            line-height: 1.4;
        }
        #startBtn:active {
            transform: scale(0.96);
            box-shadow: 0 4px 10px rgba(216, 168, 168, 0.4);
        }

        /* 傾きビジュアライザー：ゴールドとパールのデザイン */
        #visualizer {
            display: none;
            position: relative;
            width: 220px; height: 220px;
            border: 2px solid var(--gold); /* ゴールドの枠 */
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4); /* 半透明の白 */
            box-shadow: inset 0 0 20px rgba(197, 165, 114, 0.15);
            margin-top: 30px;
        }
        /* 中心点 */
        #center-point {
            position: absolute; top: 50%; left: 50%;
            width: 8px; height: 8px;
            background: var(--text-brown);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        /* 動くボール（パール） */
        #tilt-ball {
            position: absolute; top: 50%; left: 50%;
            width: 36px; height: 36px;
            background: var(--accent-pink);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(109, 76, 65, 0.2);
            /* パールの光沢感 */
            background-image: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), transparent);
            transition: top 0.1s, left 0.1s;
        }
        
        #status {
            margin-top: 25px;
            font-size: 0.9em;
            color: var(--text-brown);
            font-family: 'Cinzel', serif;
        }
    </style>
</head>
<body>
    <h1>CONTROLLER</h1>
    <p>ID: <span id="myid" style="font-family: 'Cinzel', serif;">...</span></p>
    
    <button id="startBtn" onclick="requestPermission()">TAP TO<br>CONNECT</button>
    
    <div id="visualizer">
        <div id="center-point"></div>
        <div id="tilt-ball"></div>
    </div>
    
    <div id="status">UNCONNECTED</div>

    <script>
        const socket = io();
        const myid = Math.random().toString(36).substring(2, 6).toUpperCase();
        document.getElementById("myid").innerText = myid;

        function requestPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(resp => {
                    if (resp === 'granted') startSensor();
                }).catch(e => alert("センサー許可が必要です"));
            } else {
                startSensor();
            }
        }

        function startSensor() {
            document.getElementById("startBtn").style.display = "none";
            document.getElementById("visualizer").style.display = "block";
            const status = document.getElementById("status");
            status.innerText = "CONNECTED / SENDING...";
            status.style.color = "var(--accent-pink)"; // 接続時の色
            
            socket.emit("join", "game");

            window.addEventListener("deviceorientation", (e) => {
                socket.emit("sensor", {
                    room: "game",
                    id: myid,
                    g: e.gamma,
                    b: e.beta
                });
                updateVisualizer(e.gamma, e.beta);
            });
        }

        function updateVisualizer(g, b) {
            const ball = document.getElementById("tilt-ball");
            // 傾きの感度を少し調整
            let x = (g / 40) * 90;
            let y = (b / 40) * 90;
            
            // 範囲制限（ビジュアライザーのサイズに合わせて調整）
            x = Math.max(-95, Math.min(95, x));
            y = Math.max(-95, Math.min(95, y));

            ball.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        }
    </script>
</body>
</html>